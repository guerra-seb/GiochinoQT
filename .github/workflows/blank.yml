name: Windows Release (Qt)

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Pin Python (alcune versioni recenti hanno dato noie con aqt)
      - name: Setup Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # Installa Qt (LTS stabile). Se fallisse, prova 6.6.3 o 6.7.2.
      - name: Install Qt 6.5.3 (MSVC 2022 x64)
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.5.3'
          host: 'windows'
          target: 'desktop'
          arch: 'win64_msvc2022_64'
          aqtversion: '==3.1.*'
          cache: 'true'

      - name: Check Qt tools are available
        shell: pwsh
        run: |
          where windeployqt
          echo "Qt6_DIR=$env:Qt6_DIR"

      - name: Configure (CMake VS2022 x64)
        run: >
          cmake -S . -B build -G "Visual Studio 17 2022" -A x64
          -DCMAKE_BUILD_TYPE=Release
          -DCMAKE_PREFIX_PATH="%Qt6_DIR%"

      - name: Build
        run: cmake --build build --config Release

      - name: Install to staging dir
        run: cmake --install build --config Release --prefix build/install

      # ⬇️ CAMBIA 'giochino.exe' se il tuo target ha un altro nome
      - name: Verify exe exists
        shell: pwsh
        run: |
          $exe = Join-Path "build/install" "giochino.exe"
          if (-not (Test-Path $exe)) {
            Write-Host "Contenuto build/install:"
            Get-ChildItem -Recurse build/install | ForEach-Object { $_.FullName }
            throw "Eseguibile non trovato in build/install. Controlla il nome del target o l'install() in CMake."
          }

      - name: Bundle Qt DLLs with windeployqt
        shell: pwsh
        run: |
          $exe = Join-Path "build/install" "Giochiamo.exe"
          windeployqt --release --compiler-runtime $exe

      - name: Zip portable folder
        run: powershell Compress-Archive -Path build\install\* -DestinationPath giochino-windows.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: giochino-windows
          path: giochino-windows.zip
